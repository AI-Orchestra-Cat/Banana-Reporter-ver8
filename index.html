<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>バナナレポーター v8.0</title>
    <link rel="stylesheet" href="style.css">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- セキュア設定ファイル -->
    <script src="config.js"></script>
    <script>
        // Supabaseクライアントを動的に初期化
        if (typeof window.supabase !== 'undefined' && window.APP_CONFIG) {
            window.supabaseClient = window.supabase.createClient(
                window.APP_CONFIG.SUPABASE_URL, 
                window.APP_CONFIG.SUPABASE_ANON_KEY
            );
        } else {
            console.error('❌ Supabase initialization failed: Missing configuration');
        }
    </script>
</head>
<body>
    <!-- 認証画面 -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-card">
            <h2 class="auth-title">🍌 バナナレポーター</h2>
            <div class="form-group">
                <label class="form-label">ユーザーID</label>
                <input type="text" class="form-control" id="userId" autocomplete="username">
            </div>
            <div class="form-group">
                <label class="form-label">パスワード</label>
                <input type="password" class="form-control" id="password" autocomplete="current-password">
            </div>
            <button class="btn btn-primary btn-block" id="loginBtn">ログイン</button>
            <div id="loginError" class="error-message hidden"></div>
        </div>
    </div>

    <!-- メイン画面 -->
    <div class="container hidden" id="mainScreen">
        <div class="header">
            <h1>🍌 バナナレポーター</h1>
            <div class="subtitle">品質管理システム v8.0 - <span id="currentUserDisplay"></span></div>
        </div>

        <!-- 画像入力セクション -->
        <div class="card">
            <h3>📸 画像入力</h3>
            <div class="btn-group">
                <button class="btn btn-primary" id="cameraBtn">📷 カメラ撮影</button>
                <button class="btn btn-secondary" id="fileBtn">📁 ファイル選択</button>
            </div>
            <input type="file" class="file-input hidden" id="cameraInput" accept="image/*" capture="environment">
            <input type="file" class="file-input hidden" id="fileInput" accept="image/*">
            
            <div class="image-preview" id="imagePreview">
                <div class="image-placeholder">画像が選択されていません</div>
            </div>

            <!-- 目視判定セクション -->
            <div class="visual-judgment-section hidden" id="visualJudgment">
                <h4>👁️ 目視判定（任意）</h4>
                <div class="visual-color-chart" id="visualColorChart"></div>
                <input type="text" class="form-control" id="visualJudgmentMemo" placeholder="判定理由やメモ（任意）">
            </div>

        </div>

        <!-- 目視選択カラーチャート -->
        <div class="card">
            <h3>👁️ 目視選択</h3>
            <div style="margin-bottom: 15px;">
                <span><strong>選択されたカラー:</strong> <span id="selectedColorText">未選択</span></span>
            </div>
            <div class="color-chart" id="colorChart"></div>
            
            <!-- 解析実行ボタンを目視選択の下に移動 -->
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-success btn-analyze" id="analyzeBtn" disabled>🔍 解析実行</button>
            </div>
        </div>

        <!-- 解析結果 -->
        <div class="card hidden" id="resultCard">
            <h3>📊 解析結果</h3>
            <div id="resultContent"></div>
        </div>

        <!-- 商品情報入力 -->
        <div class="card">
            <h3>📝 商品情報</h3>
            
            <div class="form-group">
                <label class="form-label">チェーン名 <span class="required">*</span></label>
                <select class="form-select" id="chainName">
                    <option value="">選択してください</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">店舗名 <span class="required">*</span></label>
                <select class="form-select" id="storeName">
                    <option value="">チェーンを先に選択してください</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">商品名 <span class="required">*</span></label>
                <select class="form-select" id="productName">
                    <option value="">選択してください</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">クレーム種別 <span class="required">*</span></label>
                <select class="form-select" id="claimType">
                    <option value="">選択してください</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">納品日 <span class="required">*</span></label>
                <input type="date" class="form-control" id="deliveryDate" max="">
            </div>

            <div class="form-group">
                <label class="form-label">撮影日 <span class="required">*</span></label>
                <input type="date" class="form-control" id="captureDate" max="">
            </div>

            <div class="form-group">
                <label class="form-label">コメント</label>
                <textarea class="form-control" id="commentText" rows="3" placeholder="追加の情報やコメントを入力してください"></textarea>
            </div>

            <!-- コード1〜3 -->
            <div class="form-group">
                <label class="form-label"><span id="code1Label">コード1</span></label>
                <input type="text" class="form-control" id="code1" placeholder="コード1を入力してください">
            </div>

            <div class="form-group">
                <label class="form-label"><span id="code2Label">コード2</span></label>
                <input type="text" class="form-control" id="code2" placeholder="コード2を入力してください">
            </div>

            <div class="form-group">
                <label class="form-label"><span id="code3Label">コード3</span></label>
                <input type="text" class="form-control" id="code3" placeholder="コード3を入力してください">
            </div>
           
        </div>

        <!-- アクションボタン -->
        <div class="card">
            <button class="btn btn-success btn-block" id="exportBtn" disabled onclick="exportAnalysisResultCSV()">📊 CSV出力</button>
            <button class="btn btn-info btn-block" id="emailBtn" disabled onclick="sendEmail()">📧 メール送信</button>
            <button class="btn btn-danger" id="resetBtn">🔄 リセット</button>
            <button class="btn btn-secondary admin-expert" id="settingsBtn">⚙️ 設定</button>
            <button class="btn btn-primary" id="logoutBtn">🚪 ログアウト</button>
        </div>

        <!-- カラー分析設定（メイン画面下部） -->
        <div class="card hidden" id="colorAnalysisSettings">
            <h3>⚙️ システム設定</h3>
            
            <!-- 管理機能はSupabase Dashboardに移行 -->
            
            <!-- マスタデータ管理 -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: #1976d2; margin-bottom: 15px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px;" onclick="toggleMasterDataSection()">
                    🏷️ マスタデータ管理
                    <span id="masterDataToggleIcon" style="font-size: 14px;">▼</span>
                </h4>
                <div id="masterDataContent" style="display: block;">
                
                <!-- チェーン名マスタ -->
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #333; margin-bottom: 10px; font-size: 16px; font-weight: bold;">チェーン名マスタ</h5>
                    <div id="chainMasterContainer"></div>
                </div>
                
                <!-- 店舗名マスタ -->
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #333; margin-bottom: 10px; font-size: 16px; font-weight: bold;">店舗名マスタ</h5>
                    <div id="storeMasterContainer"></div>
                </div>
                
                <!-- 商品名マスタ -->
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #333; margin-bottom: 10px; font-size: 16px; font-weight: bold;">商品名マスタ</h5>
                    <div id="productMasterContainer"></div>
                </div>
                
                <!-- クレーム種別マスタ -->
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #333; margin-bottom: 10px; font-size: 16px; font-weight: bold;">クレーム種別マスタ</h5>
                    <div id="claimTypeMasterContainer"></div>
                </div>
                
                <!-- コード名称マスタ -->
                <div style="margin-bottom: 20px;">
                    <h5 style="color: #333; margin-bottom: 10px; font-size: 16px; font-weight: bold;">コード名称設定</h5>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div style="margin-bottom: 10px;">
                            <label style="display: inline-block; width: 80px; font-weight: 600;">コード1:</label>
                            <input type="text" id="code1Name" style="width: 200px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" 
                                   placeholder="例: 管理番号" onchange="updateCodeName(1)">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: inline-block; width: 80px; font-weight: 600;">コード2:</label>
                            <input type="text" id="code2Name" style="width: 200px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" 
                                   placeholder="例: ロット番号" onchange="updateCodeName(2)">
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: inline-block; width: 80px; font-weight: 600;">コード3:</label>
                            <input type="text" id="code3Name" style="width: 200px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" 
                                   placeholder="例: 仕入先コード" onchange="updateCodeName(3)">
                        </div>
                        <button class="btn btn-primary btn-sm" style="margin-top: 10px;" onclick="saveCodeNames()">💾 名称を保存</button>
                    </div>
                </div>
                </div>
            </div>
            
            <!-- 色設定管理 -->
            <div style="margin-bottom: 30px;">
                <h4 style="color: #1976d2; margin-bottom: 15px; font-size: 18px; font-weight: bold;">
                    🎨 色設定管理
                </h4>
                <div id="colorSettingsContainer"></div>
            </div>
            
            <!-- カラー判定ルール設定 -->
            <div>
                <h4 style="color: #1976d2; margin-bottom: 15px; font-size: 18px; font-weight: bold;">
                    ⚖️ カラー判定ルール設定
                </h4>
                <div id="judgmentRulesContainer"></div>
            </div>
        </div>

        <!-- 管理者パネル -->
        <div class="admin-panel hidden" id="adminPanel">
            <div class="panel-header">
                <h3>⚙️ 管理設定</h3>
                <button class="btn-close" id="closeAdminBtn">×</button>
            </div>

            <!-- ユーザー管理 -->
            <div class="section">
                <h4>👥 ユーザー管理</h4>
                <div id="userTableContainer"></div>
            </div>

            <!-- タグ入力設定 -->
            <div class="section admin-only">
                <h4>📋 必須項目設定</h4>
                <div id="requiredFields" class="tag-input-container"></div>
            </div>

            <div class="section admin-only">
                <h4>🏷️ カラー分析設定</h4>
                <div id="claimTypeManager"></div>
            </div>

            <!-- CSVインポート（将来実装） -->
            <div class="section">
                <h4>📥 CSVインポート</h4>
                <button class="btn btn-info" disabled>開発予定</button>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>